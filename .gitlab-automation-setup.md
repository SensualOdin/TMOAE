# GitLab + Power Automate Setup Guide

## Step 1: Create GitLab Personal Access Token (PAT)

1. Go to GitLab.com and sign in
2. Click your **profile picture** → **Preferences**
3. In the left sidebar, click **Access Tokens**
4. Click **Add new token**
5. Configure the token:
   - **Token name**: "Power Automate SharePoint Sync"
   - **Expiration date**: Choose your preference (or leave blank for no expiration)
   - **Select scopes**: Check these boxes:
     - ✅ `api` (Full API access)
     - ✅ `write_repository` (Write access to repository)
     - ✅ `read_repository` (Read access to repository)
6. Click **Create personal access token**
7. **IMPORTANT**: Copy the token immediately (you won't see it again!)
   - Save it in a secure location like a password manager
   - Format: `glpat-xxxxxxxxxxxxxxxxxxxx`

---

## Step 2: Get SharePoint File Information

### Find Your SharePoint Details:

1. **SharePoint Site URL**:
   - Navigate to your SharePoint site where the Excel files are stored
   - Copy the URL up to the site name
   - Example: `https://tmobile.sharepoint.com/sites/AEInventory`

2. **File Location**:
   - Navigate to the folder containing your Excel files
   - Note the folder path (e.g., "Shared Documents/Inventory Reports")
   - Note the exact file names:
     - `Mobility Hardware Report 01.16.2026.xlsx`
     - `T-Mobile Formatted Inventory Report 1.20.26.xlsx`

3. **Library Name**:
   - Usually "Documents" or "Shared Documents"

---

## Step 3: Create Power Automate Flow for GitLab

### 3.1 Start Creating the Flow

1. Go to [Power Automate](https://make.powerautomate.com)
2. Click **+ Create** in the left sidebar
3. Click **Automated cloud flow**
4. Name it: "SharePoint to GitLab - Inventory Sync"
5. Search for and select trigger: **When a file is created or modified (properties only)** (SharePoint)
6. Click **Create**

### 3.2 Configure SharePoint Trigger

1. **Site Address**: Enter your SharePoint site URL
   - Example: `https://tmobile.sharepoint.com/sites/AEInventory`

2. **Library Name**: Select your document library
   - Usually "Documents" or "Shared Documents"

3. Click **Show advanced options**
   - **Folder**: Enter the folder path if files are in a subfolder
     - Example: `/Shared Documents/Inventory Reports`

### 3.3 Add Condition to Filter Excel Files

1. Click **New step**
2. Search for and add: **Condition** (Control)
3. In the condition:
   - Click in the first field, select **File name with extension** from Dynamic content
   - Select **ends with** from dropdown
   - In the third field, type: `.xlsx`

### 3.4 Get File Content from SharePoint

1. Click **Add an action** in the **If yes** branch
2. Search for and add: **Get file content** (SharePoint)
3. Configure:
   - **Site Address**: Same SharePoint URL
   - **File Identifier**: Select **Identifier** from Dynamic content

### 3.5 Add Condition to Identify Files

1. Click **Add an action**
2. Add: **Condition** (Control)
3. Set up conditions for each file type:
   - **File name with extension** - **contains** - `Mobility Hardware Report`
   - OR
   - **File name with extension** - **contains** - `T-Mobile Formatted Inventory Report`

### 3.6 Push to GitLab (HTTP Action)

**Important**: You need the HTTP Premium connector or use the workaround below.

#### Option A: Using HTTP Action (Premium)

For each file type, add an HTTP action:

**Step 1: Get current file info from GitLab**

```
Method: GET

URI: https://gitlab.com/api/v4/projects/George.Gewinner%2Fae-inventory/repository/files/[ENCODED_FILENAME]?ref=master

Headers:
- PRIVATE-TOKEN: YOUR_GITLAB_TOKEN
- Content-Type: application/json
```

**Step 2: Parse the response**

Add **Parse JSON** action:
- Content: `@{body('HTTP_GET')}`
- Schema:
```json
{
    "type": "object",
    "properties": {
        "content": {
            "type": "string"
        }
    }
}
```

**Step 3: Update file in GitLab**

```
Method: PUT

URI: https://gitlab.com/api/v4/projects/George.Gewinner%2Fae-inventory/repository/files/[ENCODED_FILENAME]

Headers:
- PRIVATE-TOKEN: YOUR_GITLAB_TOKEN
- Content-Type: application/json

Body:
{
  "branch": "master",
  "content": "@{base64(body('Get_file_content'))}",
  "commit_message": "Auto-update from SharePoint - @{triggerOutputs()?['body/{FilenameWithExtension}']}",
  "encoding": "base64"
}
```

**Important**: Replace:
- `YOUR_GITLAB_TOKEN` with your actual token (e.g., `glpat-xxxxxxxxxxxxxxxxxxxx`)
- `[ENCODED_FILENAME]` with URL-encoded filename:
  - For `Mobility Hardware Report 01.16.2026.xlsx` → `Mobility%20Hardware%20Report%2001.16.2026.xlsx`
  - For `T-Mobile Formatted Inventory Report 1.20.26.xlsx` → `T-Mobile%20Formatted%20Inventory%20Report%201.20.26.xlsx`

---

## GitLab API Endpoints Reference

### Your Project ID
You can use either format:
- Project path: `George.Gewinner/ae-inventory` (URL encode as `George.Gewinner%2Fae-inventory`)
- Or get numeric Project ID from GitLab:
  1. Go to your project on GitLab
  2. Settings → General
  3. Copy the Project ID number

### Common GitLab API Endpoints

**Get file:**
```
GET https://gitlab.com/api/v4/projects/{project_id}/repository/files/{file_path}?ref={branch}
```

**Update file:**
```
PUT https://gitlab.com/api/v4/projects/{project_id}/repository/files/{file_path}
```

**Create file:**
```
POST https://gitlab.com/api/v4/projects/{project_id}/repository/files/{file_path}
```

---

## Step 4: Complete Flow Example

Here's a simplified flow structure for one file:

```
TRIGGER: When file modified in SharePoint
    ↓
CONDITION: Is filename "Mobility Hardware Report *.xlsx"?
    ↓ IF YES
GET: File content from SharePoint
    ↓
HTTP GET: Get current file from GitLab
    (URI: https://gitlab.com/api/v4/projects/George.Gewinner%2Fae-inventory/repository/files/Mobility%20Hardware%20Report%2001.16.2026.xlsx?ref=master)
    ↓
HTTP PUT: Update file in GitLab
    Headers:
        PRIVATE-TOKEN: glpat-xxxxxxxxxxxxxxxxxxxx
        Content-Type: application/json
    Body:
        {
          "branch": "master",
          "content": "@{base64(body('Get_file_content'))}",
          "commit_message": "Auto-update Prosys inventory from SharePoint",
          "encoding": "base64"
        }
```

---

## Step 5: Alternative - Email Notification (No Premium)

If you don't have HTTP Premium connector:

```
TRIGGER: When file modified in SharePoint
    ↓
CONDITION: Is it an inventory Excel file?
    ↓ IF YES
GET: File content from SharePoint
    ↓
SEND EMAIL: To yourself with file attached
    Subject: "SharePoint Update: [filename]"
    Body: "File has been updated in SharePoint. Please commit to GitLab."
    Attachment: File content from SharePoint
```

Then manually or use the Python script to commit.

---

## Step 6: Test Your Flow

1. Click **Save** in Power Automate
2. Modify one Excel file in SharePoint
3. Wait 1-2 minutes
4. Check:
   - Power Automate run history
   - GitLab repository commits
   - GitLab Pages deployment

---

## Step 7: Verify GitLab Pages Deployment

Your GitLab repository should have GitLab Pages configured. Check:

1. Go to your GitLab project
2. Settings → Pages
3. Verify your site URL: `https://george.gewinner.gitlab.io/ae-inventory/`
4. Check if `.gitlab-ci.yml` exists for auto-deployment

If not configured, create `.gitlab-ci.yml`:

```yaml
pages:
  stage: deploy
  script:
    - mkdir .public
    - cp -r * .public
    - mv .public public
  artifacts:
    paths:
      - public
  only:
    - master
```

---

## Troubleshooting

### Common Issues:

1. **HTTP 404 - File not found**:
   - Check if file exists in repository
   - Verify URL encoding of filename
   - Use POST instead of PUT for new files

2. **HTTP 401 - Unauthorized**:
   - Verify GitLab token is correct
   - Check token has `api` and `write_repository` scopes
   - Ensure token hasn't expired

3. **HTTP 400 - Bad Request**:
   - Check JSON body format
   - Verify base64 encoding is correct
   - Ensure branch name is correct

4. **File not updating**:
   - Check if you're using PUT (not POST)
   - Verify project path encoding
   - Check branch name matches

### Get Project ID

If using project path doesn't work, use numeric ID:

```
GET https://gitlab.com/api/v4/projects/George.Gewinner%2Fae-inventory
Headers:
  PRIVATE-TOKEN: YOUR_TOKEN
```

Response will include `"id": 12345678` - use this instead of path.

---

## Next Steps

1. **Test with one file** first (e.g., Prosys file only)
2. **Monitor the first week** for any issues
3. **Duplicate flow** for the second file once first is working
4. **Set up failure notifications** via email
5. **Document the process** for your team

---

## Benefits of GitLab

- **Free GitLab Pages** hosting
- **Built-in CI/CD** for automatic deployment
- **Integrated** with GitLab's ecosystem
- **Private repositories** available on free tier

Your repository: https://gitlab.com/George.Gewinner/ae-inventory
Your GitLab Pages: https://george.gewinner.gitlab.io/ae-inventory/

---

## Quick Reference

**Your GitLab Info**:
- Project: `George.Gewinner/ae-inventory`
- Branch: `master`
- URL Encoded: `George.Gewinner%2Fae-inventory`

**Token Format**: `glpat-xxxxxxxxxxxxxxxxxxxx`

**API Base**: `https://gitlab.com/api/v4`

**Required Headers**:
```
PRIVATE-TOKEN: YOUR_TOKEN
Content-Type: application/json
```
