# GitHub + Power Automate Setup Guide

## Step 1: Create GitHub Personal Access Token (PAT)

1. Go to GitHub.com and sign in
2. Click your profile picture → **Settings**
3. Scroll down and click **Developer settings** (left sidebar)
4. Click **Personal access tokens** → **Tokens (classic)**
5. Click **Generate new token** → **Generate new token (classic)**
6. Configure the token:
   - **Note**: "Power Automate SharePoint Sync"
   - **Expiration**: Choose your preference (90 days, 1 year, or no expiration)
   - **Select scopes**: Check these boxes:
     - ✅ `repo` (Full control of private repositories)
       - This includes: repo:status, repo_deployment, public_repo, repo:invite, security_events
     - ✅ `workflow` (Update GitHub Action workflows)
7. Click **Generate token**
8. **IMPORTANT**: Copy the token immediately (you won't see it again!)
   - Save it in a secure location like a password manager
   - Format: `ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx`

---

## Step 2: Get SharePoint File Information

### Find Your SharePoint Details:

1. **SharePoint Site URL**:
   - Navigate to your SharePoint site where the Excel files are stored
   - Copy the URL up to the site name
   - Example: `https://yourcompany.sharepoint.com/sites/YourSite`

2. **File Location**:
   - Navigate to the folder containing your Excel files
   - Note the folder path (e.g., "Shared Documents/Inventory Reports")
   - Note the exact file names:
     - `Mobility Hardware Report 01.16.2026.xlsx` (or pattern like `Mobility Hardware Report *.xlsx`)
     - `T-Mobile Formatted Inventory Report 1.20.26.xlsx` (or pattern)

3. **Library Name**:
   - Usually "Documents" or "Shared Documents"
   - You can find this in the SharePoint URL when viewing files

---

## Step 3: Create Power Automate Flow

### 3.1 Start Creating the Flow

1. Go to [Power Automate](https://make.powerautomate.com)
2. Click **+ Create** in the left sidebar
3. Click **Automated cloud flow**
4. Name it: "SharePoint to GitHub - Inventory Sync"
5. Search for and select trigger: **When a file is created or modified (properties only)** (SharePoint)
6. Click **Create**

### 3.2 Configure SharePoint Trigger

1. **Site Address**: Enter your SharePoint site URL
   - Example: `https://yourcompany.sharepoint.com/sites/YourSite`

2. **Library Name**: Select your document library
   - Usually "Documents" or "Shared Documents"

3. Click **Show advanced options**
   - **Folder**: Enter the folder path if files are in a subfolder
     - Example: `/Shared Documents/Inventory Reports`

4. Click **New step**

### 3.3 Add Condition to Filter Specific Files

1. Search for and add: **Condition** (Control)
2. In the condition:
   - Click in the first field, then select **File name with extension** from Dynamic content
   - Select **ends with** from dropdown
   - In the third field, type: `.xlsx`

3. In the **If yes** branch, continue with next steps below

### 3.4 Get File Content from SharePoint

1. Click **Add an action** in the **If yes** branch
2. Search for and add: **Get file content** (SharePoint)
3. Configure:
   - **Site Address**: Same SharePoint URL
   - **File Identifier**: Click field, then select **Identifier** from Dynamic content

### 3.5 Add Another Condition to Identify Specific Files

1. Click **Add an action**
2. Add: **Condition** (Control)
3. Configure two conditions for your two files:

**For Condition 1 (Prosys File):**
- **File name with extension** - **contains** - `Mobility Hardware Report`

**Or add parallel branch for Condition 2 (Connection File):**
- **File name with extension** - **contains** - `T-Mobile Formatted Inventory Report`

### 3.6 Push to GitHub (HTTP Action)

For each condition (Prosys and Connection), add these actions:

1. Click **Add an action** in the condition's **If yes** branch
2. Search for and add: **HTTP** (Premium - may require premium license)

**If you DON'T have Premium, use Option B below**

#### Option A: Using HTTP Action (Premium)

Configure the HTTP request:

```
Method: PUT

URI: https://api.github.com/repos/SensualOdin/TMOAE/contents/[FILENAME]

Headers:
- Authorization: token YOUR_GITHUB_PAT
- Content-Type: application/json

Body:
{
  "message": "Auto-update from SharePoint - [FILENAME]",
  "content": "@{base64(body('Get_file_content'))}",
  "branch": "master",
  "sha": ""
}
```

**Replace:**
- `YOUR_GITHUB_PAT` with your actual token
- `[FILENAME]` with the exact filename (for Prosys: `Mobility Hardware Report 01.16.2026.xlsx`)

**For updating existing files**, you need to get the SHA first. See detailed flow below.

#### Option B: Using Git Command (Alternative - No Premium Required)

If you don't have HTTP Premium, you can:

1. Use **Send an email (V2)** to notify yourself
2. Configure email with file attachment
3. Manually or use another automation tool to commit

OR

Use Azure Logic Apps (similar to Power Automate but with more connectors)

---

## Step 4: Complete HTTP Action with SHA Handling

To properly update existing files, you need to get the current file's SHA first:

### 4.1 Get Current File SHA

Before the PUT request, add:

1. **HTTP - GET** action:
```
Method: GET
URI: https://api.github.com/repos/SensualOdin/TMOAE/contents/[FILENAME]
Headers:
- Authorization: token YOUR_GITHUB_PAT
- Accept: application/vnd.github.v3+json
```

2. **Parse JSON** action:
   - Content: `@{body('HTTP_GET')}`
   - Schema:
```json
{
    "type": "object",
    "properties": {
        "sha": {
            "type": "string"
        }
    }
}
```

### 4.2 Update the PUT Request

Modify the PUT request body:

```json
{
  "message": "Auto-update from SharePoint - @{triggerOutputs()?['body/{FilenameWithExtension}']}",
  "content": "@{base64(body('Get_file_content'))}",
  "branch": "master",
  "sha": "@{body('Parse_JSON')?['sha']}"
}
```

---

## Step 5: Test Your Flow

1. Click **Save** in the top right
2. Upload or modify one of your Excel files in SharePoint
3. Wait 1-2 minutes for the flow to trigger
4. Check:
   - Power Automate run history (should show success)
   - GitHub repository (file should be updated)
   - GitLab mirror (should auto-sync if configured)

---

## Step 6: Monitor and Troubleshoot

### Check Flow Runs:
1. Go to Power Automate
2. Click **My flows**
3. Click your flow name
4. Click **28-day run history**
5. Click any run to see details

### Common Issues:

1. **Flow doesn't trigger**:
   - Check SharePoint folder path is correct
   - Verify file is actually being modified (check modified date)
   - Check if flow is turned on

2. **GitHub update fails**:
   - Verify PAT has correct permissions
   - Check if SHA is being retrieved correctly
   - Verify repository name and branch are correct

3. **File content empty**:
   - Ensure "Get file content" is using correct identifier
   - Check file isn't locked/checked out in SharePoint

---

## Simplified Flow Structure

```
TRIGGER: When file is created or modified in SharePoint
    ↓
CONDITION: Is file an Excel file? (.xlsx)
    ↓ IF YES
GET: File content from SharePoint
    ↓
CONDITION: Which file is it?
    ↓ IF Prosys File
    GET: Current SHA from GitHub (Prosys file)
    PARSE JSON: Extract SHA
    HTTP PUT: Update Prosys file on GitHub
    ↓ IF Connection File
    GET: Current SHA from GitHub (Connection file)
    PARSE JSON: Extract SHA
    HTTP PUT: Update Connection file on GitHub
```

---

## Alternative: Simpler Email Notification Flow

If HTTP Premium isn't available, create this simpler flow:

```
TRIGGER: When file is created or modified in SharePoint
    ↓
CONDITION: Is it an inventory Excel file?
    ↓ IF YES
GET: File content from SharePoint
    ↓
SEND EMAIL: To yourself with file attached
```

Then you can manually commit or set up a local script to monitor your email.

---

## Next Steps After Setup

1. **Test with both files**: Modify each Excel file to ensure both flows work
2. **Set up notifications**: Add email notifications on failure
3. **Document the process**: Share with team members who update files
4. **Monitor first week**: Check daily to ensure reliability

---

## GitLab Auto-Sync

Your GitLab repository should automatically sync from GitHub since you have both remotes configured. Every time GitHub is updated, you can manually trigger a sync or set up a webhook.

To verify GitLab auto-syncs:
```bash
cd "c:\Users\GGewinn\OneDrive - T-Mobile USA\Desktop\GitHub\AE Inventory"
git remote -v
```

You should see both `origin` (GitHub) and `gitlab` remotes. GitLab Pages will auto-deploy when the gitlab remote is updated.

---

## Questions or Issues?

- Check Power Automate's built-in error messages
- Test with one file first before enabling for both
- Consider using Flow Checker (in Power Automate) to validate your flow
